version: "2"

services:
  postgres:
    image: postgres:9.4
    environment:
      POSTGRES_USER:     aleph
      POSTGRES_PASSWORD: aleph
      POSTGRES_DATABASE: aleph

  elasticsearch:
    image: elasticsearch:2.2.0

  rabbitmq:
    image: rabbitmq

  worker:
    image: pudo/aleph-base:latest
    working_dir: /aleph
    command: ls
    links:
      - postgres
      - elasticsearch
      - rabbitmq
    volumes:
      - "./build/logs/worker:/var/log"
      - "./build/archive:/data"
      - "./:/aleph"
      - "polyglot:/polyglot"
    environment: &environment
      C_FORCE_ROOT: "true"
      ALEPH_ELASTICSEARCH_URI: http://elasticsearch:9200/
      ALEPH_DATABASE_URI: postgresql://aleph:aleph@postgres/aleph
      ALEPH_BROKER_URI: amqp://guest:guest@rabbitmq:5672
      POLYGLOT_DATA_PATH: /polyglot
    env_file:
      - aleph.env

  beat:
    image: pudo/aleph-base:latest
    working_dir: /aleph
    command: make install beat
    links:
      - postgres
      - elasticsearch
      - rabbitmq
    volumes:
      - "./build/logs/beat:/var/log"
      - "./build/data/beat:/var/lib"
      - "./build/archive:/data"
      - "./:/aleph"
      - "polyglot:/polyglot"
    environment: *environment
    env_file:
      - aleph.env

  app:
    image: pudo/aleph-base:latest
    working_dir: /aleph
    command: make install app
    ports:
      - "13376:8000"
    links:
      - postgres
      - elasticsearch
      - rabbitmq
    volumes:
      - "./build/logs/web:/var/log"
      - "./build/archive:/data"
      - "./:/aleph"
      - "polyglot:/polyglot"
    environment: *environment
    env_file:
      - aleph.env

volumes:
  polyglot:
